{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto" id="fileManager">
  {% if current_folder_name %}
  <div class="mb-4">
    <nav class="flex items-center text-sm text-gray-400" aria-label="Навигация">
      <a href="{% url 'file_list' %}" class="text-gray-900 hover:text-gold-dark flex items-center">
        Мои файлы
      </a>
      
      {% if breadcrumbs|length > 1 %}
        <i data-lucide="chevron-right" class="w-3 h-3 mx-0.5"></i>
        
        {% for crumb in breadcrumbs %}
          {% if not forloop.first and not forloop.last %}
            <a href="{% url 'file_list' %}{% if crumb.path %}?path={{ crumb.path|urlencode }}{% endif %}" 
               class="hover:text-black truncate max-w-[120px]">
              {{ crumb.name }}
            </a>
            <i data-lucide="chevron-right" class="w-3 h-3 mx-0.5"></i>
          {% elif forloop.last %}
            <span class="text-gray-900 font-medium truncate max-w-[120px]">
              {{ crumb.name }}
            </span>
          {% endif %}
        {% endfor %}
      {% endif %}
    </nav>
  </div>
  {% endif %}

  <div class="flex flex-col sm:flex-row justify-between items-end border-2 border-transparent pb-2 border-b-black/10 gap-4 mb-6">
    <div>
      <h1 class="text-3xl font-medium text-gray-900">
        {% if current_folder_name %}
          {{ current_folder_name|truncatechars:60 }}
        {% else %}
          Мои файлы
        {% endif %}
      </h1>
    </div>
    
    <div class="flex flex-wrap gap-2">
      <a href="{% url 'upload_file' %}{% if current_path %}?path={{ current_path|urlencode }}{% endif %}" 
         class="flex text-sm items-center gap-1 bg-gradient-to-r from-amber-500 to-amber-700 text-white px-3 py-2 rounded-lg hover:opacity-90 transition-all shadow-sm">
        <i data-lucide="upload" class="w-3 h-3"></i>
        Загрузить
      </a>
      
      <button onclick="showCreateFolderModal()"
        class="flex text-sm items-center gap-1 bg-white text-gray-700 px-3 py-2 rounded-lg border border-gray-300 hover:border-gold hover:text-gold transition-all">
        <i data-lucide="folder-plus" class="w-3 h-3"></i>
        Новая папка
      </button>
      
      {% if current_folder %}
        <button onclick="showDeleteFolderModal('{{ current_folder.pk }}', '{{ current_folder.name|escapejs }}')"
                class="flex text-sm items-center gap-1 bg-white text-red-600 px-3 py-2 rounded-lg border border-red-200 hover:bg-red-50 transition-all">
          <i data-lucide="trash-2" class="w-3 h-3"></i>
          Удалить папку
        </button>
      {% endif %}
    </div>
  </div>

  <div id="filesContainer" class="relative min-h-[400px]">
    {% if folders or files %}
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-8 gap-6">
        {% for folder in folders %}
          {% include 'storage/components/item_card.html' with item=folder item_type='folder' %}
        {% endfor %}
      
        {% for file in files %}
          {% include 'storage/components/item_card.html' with item=file item_type='file' %}
        {% endfor %}
      </div>
    {% else %}
    <div id="emptyArea" 
         class="text-center py-12 border-2 border-dashed border-gray-300 rounded-xl hover:border-amber-400 transition-colors duration-200 min-h-[300px] flex flex-col items-center justify-center">
      <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
        <i data-lucide="folder-open" class="w-12 h-12 text-gray-400"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">Папка пуста</h3>
      <p class="text-gray-500">Добавьте файлы или создайте папки</p>
      <p class="text-gray-400 text-sm mt-4">Нажмите правой кнопкой мыши для создания папки</p>
    </div>
    {% endif %}
  </div>
</div>

<div id="contextMenu" class="hidden fixed z-50 bg-white border border-gray-200 rounded-lg shadow-lg min-w-[200px]">
  <button onclick="showCreateFolderModal(); hideAllMenus()" 
          class="w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-100 flex items-center gap-3">
    <i data-lucide="folder-plus" class="w-4 h-4 text-gray-500"></i>
    <span>Новая папка</span>
  </button>
  
  <a href="{% url 'upload_file' %}{% if current_path %}?path={{ current_path|urlencode }}{% endif %}" 
     class="block px-4 py-2 text-left text-gray-700 hover:bg-gray-100 flex items-center gap-3"
     onclick="hideAllMenus()">
    <i data-lucide="upload" class="w-4 h-4 text-gray-500"></i>
    <span>Загрузить файл</span>
  </a>
  
  <div class="border-t border-gray-200"></div>
  
  <button onclick="location.reload(); hideAllMenus()" 
          class="w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-100 flex items-center gap-3">
    <i data-lucide="refresh-cw" class="w-4 h-4 text-gray-500"></i>
    <span>Обновить</span>
  </button>
</div>

<div id="folderContextMenu" class="hidden fixed z-50 bg-white border border-gray-200 rounded-lg shadow-lg min-w-[200px]">
  <button onclick="openSelectedFolder()" 
          class="w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-100 flex items-center gap-3">
    <i data-lucide="folder-open" class="w-4 h-4 text-gray-500"></i>
    <span>Открыть</span>
  </button>
  
  <button onclick="renameSelectedFolder()" 
          class="w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-100 flex items-center gap-3">
    <i data-lucide="edit" class="w-4 h-4 text-gray-500"></i>
    <span>Переименовать</span>
  </button>
  
  <button onclick="deleteSelectedFolder()" 
          class="w-full px-4 py-2 text-left text-red-600 hover:bg-red-50 flex items-center gap-3">
    <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
    <span>Удалить</span>
  </button>
</div>

<div id="fileContextMenu" class="hidden fixed z-50 bg-white border border-gray-200 rounded-lg shadow-lg min-w-[200px]">
  <button onclick="downloadSelectedFile()" 
          class="w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-100 flex items-center gap-3">
    <i data-lucide="download" class="w-4 h-4 text-gray-500"></i>
    <span>Скачать</span>
  </button>
  
  <button onclick="renameSelectedFile()" 
          class="w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-100 flex items-center gap-3">
    <i data-lucide="edit" class="w-4 h-4 text-gray-500"></i>
    <span>Переименовать</span>
  </button>
  
  <button onclick="deleteSelectedFile()" 
          class="w-full px-4 py-2 text-left text-red-600 hover:bg-red-50 flex items-center gap-3">
    <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
    <span>Удалить</span>
  </button>
</div>

<div id="unifiedModal" class="modal hidden">
  <div class="modal-content max-w-md w-full sm:max-w-lg">
    <div class="flex items-center justify-between mb-6">
      <h3 id="modalTitle" class="text-xl font-bold text-gray-900"></h3>
      <button onclick="closeUnifiedModal()" class="text-gray-400 hover:text-gray-600">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    
    <div id="modalMessage" class="mb-6 hidden">
      <p id="modalMessageText" class="text-gray-700 mb-2 text-base leading-relaxed"></p>
      <p id="modalMessageSubtext" class="text-sm text-gray-500 mt-1"></p>
    </div>
    
    <form id="modalForm" method="post">
      {% csrf_token %}
      <input type="hidden" id="modalItemId" name="item_id">
      <input type="hidden" id="modalItemType" name="item_type">
      <input type="hidden" id="modalAction" name="action">
      <input type="hidden" id="modalCurrentPath" name="path" value="{{ current_path }}">
      
      <div class="mb-6">
        <label id="modalLabel" class="block text-sm font-medium text-gray-700 mb-2"></label>
        <input 
          type="text" 
          id="modalInput"
          name="name"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent transition-all text-base"
          placeholder="Введите название"
          maxlength="255">
        <p id="modalError" class="mt-2 text-sm text-red-600 hidden"></p>
      </div>
      
      <div class="flex gap-3">
        <button type="submit" id="modalSubmitBtn" class="flex-1 px-6 py-3 rounded-lg transition-colors text-base font-medium">
        </button>
        <button type="button" onclick="closeUnifiedModal()" 
                class="flex-1 px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-base font-medium">
          Отмена
        </button>
      </div>
    </form>
    
    <div id="modalDeleteButtons" class="flex gap-3 hidden">
      <button id="modalDeleteConfirm" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors text-base font-medium">
        Удалить
      </button>
      <button type="button" onclick="closeUnifiedModal()" 
              class="flex-1 px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-base font-medium">
        Отмена
      </button>
    </div>
  </div>
</div>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
}

.modal.hidden {
  display: none;
}

.modal-content {
  background: white;
  border-radius: 16px;
  padding: 28px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  animation: modalSlideIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  max-width: 640px;
  width: 90vw;
}

@media (min-width: 640px) {
  .modal-content {
    width: auto;
  }
}

#modalInput {
  min-height: 44px;
  font-size: 16px;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#contextMenu,
#folderContextMenu,
#fileContextMenu {
  animation: fadeInUp 0.15s ease-out;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(5px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.selected-item {
  background-color: rgba(59, 130, 246, 0.1) !important;
  border: 1px solid rgba(59, 130, 246, 0.3) !important;
  border-radius: 12px !important;
}

.bg-red-100 { background-color: #fee2e2; }
.bg-green-100 { background-color: #dcfce7; }
.bg-blue-100 { background-color: #dbeafe; }
.bg-orange-100 { background-color: #ffedd5; }
.bg-purple-100 { background-color: #f3e8ff; }
.bg-pink-100 { background-color: #fce7f3; }
.bg-indigo-100 { background-color: #e0e7ff; }
</style>

<script>
let selectedFolder = { id: null, name: null, path: null, element: null };
let selectedFile = { id: null, name: null, element: null };

function clearSelection() {
    document.querySelectorAll('.folder-item, .file-item').forEach(item => {
        item.classList.remove('selected-item');
    });
}

const ContextMenuController = {
    currentMenu: null,
    
    show(menuElement, x, y) {
        this.hide();
        menuElement.classList.remove('hidden');
        this.currentMenu = menuElement;
        
        const rect = menuElement.getBoundingClientRect();
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        
        let finalX = Math.min(x, vw - rect.width - 10);
        let finalY = Math.min(y, vh - rect.height - 10);
        
        menuElement.style.left = finalX + 'px';
        menuElement.style.top = finalY + 'px';
        
        document.addEventListener('click', this.handleClickOutside.bind(this));
        document.addEventListener('keydown', this.handleKeyDown.bind(this));
    },
    
    hide() {
        if (this.currentMenu) {
            this.currentMenu.classList.add('hidden');
            this.currentMenu = null;
            document.removeEventListener('click', this.handleClickOutside);
            document.removeEventListener('keydown', this.handleKeyDown);
        }
    },
    
    handleClickOutside(e) {
        if (!this.currentMenu) return;
        const target = e.target;
        if (!this.currentMenu.contains(target)) {
            this.hide();
            clearSelection();
        }
    },
    
    handleKeyDown(e) {
        if (e.key === 'Escape') {
            this.hide();
            clearSelection();
        }
    }
};

function hideAllMenus() {
    ContextMenuController.hide();
    clearSelection();
}

function showContextMenu(x, y) {
    const menu = document.getElementById('contextMenu');
    if (menu) ContextMenuController.show(menu, x, y);
}

function showFolderContextMenu(x, y, folderElement) {
    clearSelection();
    folderElement.classList.add('selected-item');
    
    selectedFolder = {
        id: folderElement.getAttribute('data-folder-id'),
        name: folderElement.getAttribute('data-folder-name'),
        path: folderElement.getAttribute('data-folder-path'),
        element: folderElement
    };
    
    const menu = document.getElementById('folderContextMenu');
    if (menu) ContextMenuController.show(menu, x, y);
}

function showFileContextMenu(x, y, fileElement) {
    clearSelection();
    fileElement.classList.add('selected-item');
    
    selectedFile = {
        id: fileElement.getAttribute('data-file-id'),
        name: fileElement.getAttribute('data-file-name'),
        element: fileElement
    };
    
    const menu = document.getElementById('fileContextMenu');
    if (menu) ContextMenuController.show(menu, x, y);
}

function openSelectedFolder() {
    hideAllMenus();
    if (selectedFolder.path) {
        window.location.href = `{% url 'file_list' %}?path=${encodeURIComponent(selectedFolder.path)}`;
    }
}

function renameSelectedFolder() {
    hideAllMenus();
    if (!selectedFolder.name || !selectedFolder.id) return;
    showUnifiedModal({
        title: 'Переименовать папку',
        type: 'rename',
        itemType: 'folder',
        itemId: selectedFolder.id,
        label: 'Новое имя папки',
        placeholder: 'Введите новое название',
        defaultValue: selectedFolder.name,
        submitText: 'Переименовать',
        submitClass: 'bg-gradient-to-r from-amber-500 to-amber-700 text-white hover:opacity-90'
    });
}

function deleteSelectedFolder() {
    hideAllMenus();
    if (!selectedFolder.name || !selectedFolder.id) return;
    showUnifiedModal({
        title: 'Удалить папку',
        type: 'delete',
        itemType: 'folder',
        itemId: selectedFolder.id,
        message: `Вы уверены, что хотите удалить папку "${selectedFolder.name}"?`,
        subtext: 'Будет удалено всё содержимое папки. Это действие необратимо.'
    });
}

function downloadSelectedFile() {
    hideAllMenus();
    if (selectedFile.id) {
        window.location.href = `{% url 'download_file' 0 %}`.replace('0', selectedFile.id);
    }
}

function renameSelectedFile() {
    hideAllMenus();
    if (!selectedFile.name || !selectedFile.id) return;
    const nameWithoutExt = selectedFile.name.includes('.') 
        ? selectedFile.name.substring(0, selectedFile.name.lastIndexOf('.'))
        : selectedFile.name;
    showUnifiedModal({
        title: 'Переименовать файл',
        type: 'rename',
        itemType: 'file',
        itemId: selectedFile.id,
        label: 'Новое имя файла',
        placeholder: 'Введите новое название',
        defaultValue: nameWithoutExt,
        submitText: 'Переименовать',
        submitClass: 'bg-gradient-to-r from-amber-500 to-amber-700 text-white hover:opacity-90'
    });
}

function deleteSelectedFile() {
    hideAllMenus();
    if (!selectedFile.name || !selectedFile.id) return;
    showUnifiedModal({
        title: 'Удалить файл',
        type: 'delete',
        itemType: 'file',
        itemId: selectedFile.id,
        message: `Удалить файл "${selectedFile.name}"?`,
        subtext: 'Это действие необратимо.'
    });
}

function showEmptyAreaContextMenu(e) {
    e.preventDefault();
    clearSelection();
    showContextMenu(e.clientX, e.clientY);
}

function showDeleteFolderModal(folderId, folderName) {
    if (!folderId || !folderName) return;
    showUnifiedModal({
        title: 'Удалить папку',
        type: 'delete',
        itemType: 'folder',
        itemId: folderId,
        message: `Вы уверены, что хотите удалить папку "${folderName}"?`,
        subtext: 'Будет удалено всё содержимое папки. Это действие необратимо.'
    });
}

function showUnifiedModal(config) {
    hideAllMenus();
    
    const modal = document.getElementById('unifiedModal');
    const title = document.getElementById('modalTitle');
    const messageDiv = document.getElementById('modalMessage');
    const formDiv = document.getElementById('modalForm');
    const deleteButtons = document.getElementById('modalDeleteButtons');
    const label = document.getElementById('modalLabel');
    const input = document.getElementById('modalInput');
    const submitBtn = document.getElementById('modalSubmitBtn');
    const errorEl = document.getElementById('modalError');
    const messageText = document.getElementById('modalMessageText');
    const messageSubtext = document.getElementById('modalMessageSubtext');
    
    messageDiv.classList.add('hidden');
    formDiv.classList.add('hidden');
    deleteButtons.classList.add('hidden');
    errorEl.classList.add('hidden');
    title.textContent = config.title;
    
    if (config.type === 'delete') {
        messageDiv.classList.remove('hidden');
        deleteButtons.classList.remove('hidden');
        messageText.textContent = config.message;
        messageSubtext.textContent = config.subtext || '';
        document.getElementById('modalItemId').value = config.itemId;
        document.getElementById('modalItemType').value = config.itemType;
        document.getElementById('modalAction').value = 'delete';
        
        document.getElementById('modalDeleteConfirm').onclick = () => {
            if (config.itemType === 'folder') deleteFolderConfirmed(config.itemId);
            else deleteFileConfirmed(config.itemId);
        };
    } else if (config.type === 'rename' || config.type === 'create') {
        formDiv.classList.remove('hidden');
        label.textContent = config.label;
        input.placeholder = config.placeholder;
        input.value = config.defaultValue || '';
        submitBtn.textContent = config.submitText;
        submitBtn.className = 'flex-1 px-6 py-3 rounded-lg transition-colors ' + config.submitClass;
        document.getElementById('modalItemId').value = config.itemId || '';
        document.getElementById('modalItemType').value = config.itemType;
        document.getElementById('modalAction').value = config.type;
        setTimeout(() => input.focus(), 100);
    }
    
    modal.classList.remove('hidden');
}

function closeUnifiedModal() {
    document.getElementById('unifiedModal').classList.add('hidden');
    clearSelection();
}

function deleteFolderConfirmed(folderId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "delete_folder" %}';
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrf) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrf.value;
        form.appendChild(csrfInput);
    }
    const idInput = document.createElement('input');
    idInput.type = 'hidden';
    idInput.name = 'folder_id';
    idInput.value = folderId;
    form.appendChild(idInput);
    document.body.appendChild(form);
    form.submit();
}

function deleteFileConfirmed(fileId) {
    window.location.href = `{% url 'delete_file' 0 %}`.replace('0', fileId);
}

function validateModalInput(itemType, value) {
    if (!value.trim()) {
        return itemType === 'folder' 
            ? 'Имя папки не может быть пустым'
            : 'Имя файла не может быть пустым';
    }
    const forbidden = ['/', '\\', ':', '*', '?', '"', '<', '>', '|'];
    for (const char of forbidden) {
        if (value.includes(char)) {
            return `Имя не может содержать символ "${char}"`;
        }
    }
    if (value.endsWith('.') || value.endsWith(' ')) {
        return 'Имя не может заканчиваться точкой или пробелом';
    }
    return null;
}

document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') lucide.createIcons();
    
    const modalForm = document.getElementById('modalForm');
    if (modalForm) {
        modalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const action = document.getElementById('modalAction').value;
            const newName = document.getElementById('modalInput').value;
            const errorEl = document.getElementById('modalError');
            
            const error = validateModalInput('folder', newName);
            if (error) {
                errorEl.textContent = error;
                errorEl.classList.remove('hidden');
                return;
            }
            errorEl.classList.add('hidden');
            
            if (action === 'create') {
                this.submit();
            } else {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = document.getElementById('modalItemType').value === 'folder' 
                    ? '{% url "rename_folder" %}' 
                    : '{% url "rename_file" %}';
                
                const csrf = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrf) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = csrf.value;
                    form.appendChild(csrfInput);
                }
                
                const idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.name = document.getElementById('modalItemType').value === 'folder' ? 'folder_id' : 'file_id';
                idInput.value = document.getElementById('modalItemId').value;
                form.appendChild(idInput);
                
                const nameInput = document.createElement('input');
                nameInput.type = 'hidden';
                nameInput.name = 'new_name';
                nameInput.value = newName;
                form.appendChild(nameInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
    
    document.querySelectorAll('.folder-item').forEach(el => {
        el.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showFolderContextMenu(e.clientX, e.clientY, el);
        });
    });
    
    document.querySelectorAll('.file-item').forEach(el => {
        el.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showFileContextMenu(e.clientX, e.clientY, el);
        });
    });
    
    const emptyArea = document.getElementById('emptyArea');
    if (emptyArea) {
        emptyArea.addEventListener('contextmenu', showEmptyAreaContextMenu);
    }
    
    const fileManager = document.getElementById('fileManager');
    if (fileManager) {
        fileManager.addEventListener('contextmenu', (e) => {
            const target = e.target;
            const isItem = target.closest('.folder-item') || target.closest('.file-item');
            const isEmptyArea = target.id === 'emptyArea' || target.closest('#emptyArea');
            
            if (!isItem && !isEmptyArea) {
                e.preventDefault();
                showEmptyAreaContextMenu(e);
            }
        });
    }
    
    document.addEventListener('click', (e) => {
        const target = e.target;
        const isItem = target.closest('.folder-item') || target.closest('.file-item');
        const isMenu = target.closest('#contextMenu') || 
                      target.closest('#folderContextMenu') || 
                      target.closest('#fileContextMenu');
        const isModal = target.closest('#unifiedModal');
        
        if (!isItem && !isMenu && !isModal) {
            clearSelection();
        }
    });
});

document.getElementById('unifiedModal')?.addEventListener('click', (e) => {
    if (e.target === document.getElementById('unifiedModal')) {
        closeUnifiedModal();
    }
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeUnifiedModal();
        ContextMenuController.hide();
        clearSelection();
    }
});

function showCreateFolderModal() {
    showUnifiedModal({
        title: 'Создать папку',
        type: 'create',
        itemType: 'folder',
        label: 'Имя папки',
        placeholder: 'Введите название папки',
        submitText: 'Создать',
        submitClass: 'bg-gradient-to-r from-amber-500 to-amber-700 text-white hover:opacity-90'
    });
}
</script>
{% endblock %}