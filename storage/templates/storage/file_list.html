{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6" id="fileManager">
  
  {% if current_folder_name %}
  <div class="mb-6">
    <nav class="flex items-center text-sm text-gray-500 flex-wrap" aria-label="Навигация">
      <a href="{% url 'file_list' %}" class="text-gray-700 hover:text-gray-900 flex items-center">
        Мои файлы
      </a>
      
      {% if breadcrumbs|length > 1 %}
        <i data-lucide="chevron-right" class="w-4 h-4 mx-1 text-gray-400"></i>
        
        {% for crumb in breadcrumbs %}
          {% if not forloop.first and not forloop.last %}
            <a href="{% url 'file_list' %}{% if crumb.path %}?path={{ crumb.path|urlencode }}{% endif %}" 
               class="hover:text-gray-900 truncate max-w-[100px] sm:max-w-[150px]">
              {{ crumb.name }}
            </a>
            <i data-lucide="chevron-right" class="w-4 h-4 mx-1 text-gray-400"></i>
          {% elif forloop.last %}
            <span class="text-gray-900 font-medium truncate max-w-[150px] sm:max-w-[200px]">
              {{ crumb.name }}
            </span>
          {% endif %}
        {% endfor %}
      {% endif %}
    </nav>
  </div>
  {% endif %}

  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-5 mb-6 border-b border-gray-200">
    <h1 class="text-2xl sm:text-3xl font-semibold text-gray-900">
      {% if current_folder_name %}
        {{ current_folder_name|truncatechars:50 }}
      {% else %}
        Мои файлы
      {% endif %}
    </h1>
    
    <div class="flex flex-wrap gap-2 w-full sm:w-auto">
      <a href="{% url 'upload_file' %}{% if current_path %}?path={{ current_path|urlencode }}{% endif %}" 
         class="flex items-center justify-center gap-2 bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-800 transition-colors flex-1 sm:flex-none">
        <i data-lucide="upload" class="w-4 h-4"></i>
        <span>Загрузить</span>
      </a>
      
      <button onclick="showCreateFolderModal()"
        class="flex items-center justify-center gap-2 bg-white text-gray-700 px-4 py-2 rounded-lg text-sm font-medium border border-gray-300 hover:border-gray-400 hover:bg-gray-50 transition-colors flex-1 sm:flex-none">
        <i data-lucide="folder-plus" class="w-4 h-4"></i>
        <span>Новая папка</span>
      </button>
      
      {% if current_folder %}
        <button onclick="showDeleteFolderModal('{{ current_folder.pk }}', '{{ current_folder.name|escapejs }}')"
                class="flex items-center justify-center gap-2 bg-white text-red-600 px-4 py-2 rounded-lg text-sm font-medium border border-red-200 hover:bg-red-50 transition-colors flex-1 sm:flex-none">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
          <span class="hidden sm:inline">Удалить папку</span>
          <span class="sm:hidden">Удалить</span>
        </button>
      {% endif %}
    </div>
  </div>

  <div id="filesContainer" class="relative min-h-[300px]">
    {% if folders or files %}
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-8 gap-4 sm:gap-5">
        {% for folder in folders %}
          {% include 'storage/components/item_card.html' with item=folder item_type='folder' %}
        {% endfor %}
      
        {% for file in files %}
          {% include 'storage/components/item_card.html' with item=file item_type='file' %}
        {% endfor %}
      </div>
    {% else %}
    <div id="emptyArea" 
         class="text-center py-16 border-2 border-dashed border-gray-200 rounded-xl min-h-[300px] flex flex-col items-center justify-center bg-gray-50/50">
      <div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
        <i data-lucide="folder-open" class="w-10 h-10 text-gray-400"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-1">Папка пуста</h3>
      <p class="text-gray-500 text-sm mb-4">Добавьте файлы или создайте папки</p>
      <button onclick="showCreateFolderModal()" class="text-sm text-gray-600 hover:text-gray-900 underline underline-offset-2">
        Создать папку
      </button>
    </div>
    {% endif %}
  </div>
</div>

<div id="contextMenu" class="hidden fixed z-50 bg-white border border-gray-200 rounded-lg shadow-lg min-w-[180px] py-1">
  <button onclick="showCreateFolderModal(); hideAllMenus()" 
          class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3">
    <i data-lucide="folder-plus" class="w-4 h-4 text-gray-500"></i>
    <span>Новая папка</span>
  </button>
  
  <a href="{% url 'upload_file' %}{% if current_path %}?path={{ current_path|urlencode }}{% endif %}" 
     class="block px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3"
     onclick="hideAllMenus()">
    <i data-lucide="upload" class="w-4 h-4 text-gray-500"></i>
    <span>Загрузить файл</span>
  </a>
  
  <div class="border-t border-gray-100 my-1"></div>
  
  <button onclick="location.reload(); hideAllMenus()" 
          class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3">
    <i data-lucide="refresh-cw" class="w-4 h-4 text-gray-500"></i>
    <span>Обновить</span>
  </button>
</div>

<div id="folderContextMenu" class="hidden fixed z-50 bg-white border border-gray-200 rounded-lg shadow-lg min-w-[180px] py-1">
  <button onclick="openSelectedFolder()" 
          class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3">
    <i data-lucide="folder-open" class="w-4 h-4 text-gray-500"></i>
    <span>Открыть</span>
  </button>
  
  <button onclick="renameSelectedFolder()" 
          class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3">
    <i data-lucide="edit" class="w-4 h-4 text-gray-500"></i>
    <span>Переименовать</span>
  </button>
  
  <div class="border-t border-gray-100 my-1"></div>
  
  <button onclick="deleteSelectedFolder()" 
          class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-3">
    <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
    <span>Удалить</span>
  </button>
</div>

<div id="fileContextMenu" class="hidden fixed z-50 bg-white border border-gray-200 rounded-lg shadow-lg min-w-[180px] py-1">
  <button onclick="downloadSelectedFile()" 
          class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3">
    <i data-lucide="download" class="w-4 h-4 text-gray-500"></i>
    <span>Скачать</span>
  </button>
  
  <button onclick="renameSelectedFile()" 
          class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3">
    <i data-lucide="edit" class="w-4 h-4 text-gray-500"></i>
    <span>Переименовать</span>
  </button>
  
  <div class="border-t border-gray-100 my-1"></div>
  
  <button onclick="deleteSelectedFile()" 
          class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-3">
    <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
    <span>Удалить</span>
  </button>
</div>

<div id="unifiedModal" class="modal hidden">
  <div class="modal-content max-w-md w-full">
    <div class="flex items-center justify-between mb-5">
      <h3 id="modalTitle" class="text-xl font-semibold text-gray-900"></h3>
      <button onclick="closeUnifiedModal()" class="text-gray-400 hover:text-gray-600 p-1">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    
    <div id="modalMessage" class="mb-6 hidden">
      <p id="modalMessageText" class="text-gray-700 mb-1"></p>
      <p id="modalMessageSubtext" class="text-sm text-gray-500"></p>
    </div>
    
    <form id="modalForm" method="post">
      {% csrf_token %}
      <input type="hidden" id="modalItemId" name="item_id">
      <input type="hidden" id="modalItemType" name="item_type">
      <input type="hidden" id="modalAction" name="action">
      <input type="hidden" id="modalCurrentPath" name="path" value="{{ current_path }}">
      
      <div class="mb-5">
        <label id="modalLabel" class="block text-sm font-medium text-gray-700 mb-2"></label>
        <input 
          type="text" 
          id="modalInput"
          name="name"
          class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-gray-500 focus:ring-1 focus:ring-gray-500 text-base"
          placeholder="Введите название"
          maxlength="255">
        <p id="modalError" class="mt-2 text-sm text-red-600 hidden"></p>
      </div>
      
      <div class="flex flex-col sm:flex-row gap-3">
        <button type="submit" id="modalSubmitBtn" class="flex-1 px-4 py-2.5 rounded-lg text-sm font-medium bg-gray-900 text-white hover:bg-gray-800 transition-colors">
        </button>
        <button type="button" onclick="closeUnifiedModal()" 
                class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
          Отмена
        </button>
      </div>
    </form>
    
    <div id="modalDeleteButtons" class="flex flex-col sm:flex-row gap-3 hidden">
      <button id="modalDeleteConfirm" class="flex-1 bg-red-600 text-white px-4 py-2.5 rounded-lg text-sm font-medium hover:bg-red-700 transition-colors">
        Удалить
      </button>
      <button type="button" onclick="closeUnifiedModal()" 
              class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
        Отмена
      </button>
    </div>
  </div>
</div>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 16px;
}

.modal.hidden {
  display: none;
}

.modal-content {
  background: white;
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
  animation: modalFadeIn 0.2s ease-out;
  width: 90vw;
  max-width: 500px;
}

@keyframes modalFadeIn {
  from {
    opacity: 0;
    transform: scale(0.98);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.selected-item {
  background-color: #f3f4f6 !important;
  border-radius: 12px !important;
}
</style>

<script>
let selectedFolder = { id: null, name: null, path: null, element: null };
let selectedFile = { id: null, name: null, element: null };

function clearSelection() {
    document.querySelectorAll('.folder-item, .file-item').forEach(item => {
        item.classList.remove('selected-item');
    });
}

const ContextMenuController = {
    currentMenu: null,
    
    show(menuElement, x, y) {
        this.hide();
        menuElement.classList.remove('hidden');
        this.currentMenu = menuElement;
        
        const rect = menuElement.getBoundingClientRect();
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        
        let finalX = Math.min(x, vw - rect.width - 10);
        let finalY = Math.min(y, vh - rect.height - 10);
        
        menuElement.style.left = finalX + 'px';
        menuElement.style.top = finalY + 'px';
        
        document.addEventListener('click', this.handleClickOutside.bind(this));
        document.addEventListener('keydown', this.handleKeyDown.bind(this));
    },
    
    hide() {
        if (this.currentMenu) {
            this.currentMenu.classList.add('hidden');
            this.currentMenu = null;
            document.removeEventListener('click', this.handleClickOutside);
            document.removeEventListener('keydown', this.handleKeyDown);
        }
    },
    
    handleClickOutside(e) {
        if (!this.currentMenu) return;
        const target = e.target;
        if (!this.currentMenu.contains(target)) {
            this.hide();
            clearSelection();
        }
    },
    
    handleKeyDown(e) {
        if (e.key === 'Escape') {
            this.hide();
            clearSelection();
        }
    }
};

function hideAllMenus() {
    ContextMenuController.hide();
    clearSelection();
}

function showContextMenu(x, y) {
    const menu = document.getElementById('contextMenu');
    if (menu) ContextMenuController.show(menu, x, y);
}

function showFolderContextMenu(x, y, folderElement) {
    clearSelection();
    folderElement.classList.add('selected-item');
    
    selectedFolder = {
        id: folderElement.getAttribute('data-folder-id'),
        name: folderElement.getAttribute('data-folder-name'),
        path: folderElement.getAttribute('data-folder-path'),
        element: folderElement
    };
    
    const menu = document.getElementById('folderContextMenu');
    if (menu) ContextMenuController.show(menu, x, y);
}

function showFileContextMenu(x, y, fileElement) {
    clearSelection();
    fileElement.classList.add('selected-item');
    
    selectedFile = {
        id: fileElement.getAttribute('data-file-id'),
        name: fileElement.getAttribute('data-file-name'),
        element: fileElement
    };
    
    const menu = document.getElementById('fileContextMenu');
    if (menu) ContextMenuController.show(menu, x, y);
}

function openSelectedFolder() {
    hideAllMenus();
    if (selectedFolder.path) {
        window.location.href = `{% url 'file_list' %}?path=${encodeURIComponent(selectedFolder.path)}`;
    }
}

function renameSelectedFolder() {
    hideAllMenus();
    if (!selectedFolder.name || !selectedFolder.id) return;
    showUnifiedModal({
        title: 'Переименовать папку',
        type: 'rename',
        itemType: 'folder',
        itemId: selectedFolder.id,
        label: 'Новое имя папки',
        placeholder: 'Введите новое название',
        defaultValue: selectedFolder.name,
        submitText: 'Переименовать'
    });
}

function deleteSelectedFolder() {
    hideAllMenus();
    if (!selectedFolder.name || !selectedFolder.id) return;
    showUnifiedModal({
        title: 'Удалить папку',
        type: 'delete',
        itemType: 'folder',
        itemId: selectedFolder.id,
        message: `Вы уверены, что хотите удалить папку "${selectedFolder.name}"?`,
        subtext: 'Будет удалено всё содержимое папки. Это действие необратимо.'
    });
}

function downloadSelectedFile() {
    hideAllMenus();
    if (selectedFile.id) {
        window.location.href = `{% url 'download_file' 0 %}`.replace('0', selectedFile.id);
    }
}

function renameSelectedFile() {
    hideAllMenus();
    if (!selectedFile.name || !selectedFile.id) return;
    const nameWithoutExt = selectedFile.name.includes('.') 
        ? selectedFile.name.substring(0, selectedFile.name.lastIndexOf('.'))
        : selectedFile.name;
    showUnifiedModal({
        title: 'Переименовать файл',
        type: 'rename',
        itemType: 'file',
        itemId: selectedFile.id,
        label: 'Новое имя файла',
        placeholder: 'Введите новое название',
        defaultValue: nameWithoutExt,
        submitText: 'Переименовать'
    });
}

function deleteSelectedFile() {
    hideAllMenus();
    if (!selectedFile.name || !selectedFile.id) return;
    showUnifiedModal({
        title: 'Удалить файл',
        type: 'delete',
        itemType: 'file',
        itemId: selectedFile.id,
        message: `Удалить файл "${selectedFile.name}"?`,
        subtext: 'Это действие необратимо.'
    });
}

function showEmptyAreaContextMenu(e) {
    e.preventDefault();
    clearSelection();
    showContextMenu(e.clientX, e.clientY);
}

function showDeleteFolderModal(folderId, folderName) {
    if (!folderId || !folderName) return;
    showUnifiedModal({
        title: 'Удалить папку',
        type: 'delete',
        itemType: 'folder',
        itemId: folderId,
        message: `Вы уверены, что хотите удалить папку "${folderName}"?`,
        subtext: 'Будет удалено всё содержимое папки. Это действие необратимо.'
    });
}

function showUnifiedModal(config) {
    hideAllMenus();
    
    const modal = document.getElementById('unifiedModal');
    const title = document.getElementById('modalTitle');
    const messageDiv = document.getElementById('modalMessage');
    const formDiv = document.getElementById('modalForm');
    const deleteButtons = document.getElementById('modalDeleteButtons');
    const label = document.getElementById('modalLabel');
    const input = document.getElementById('modalInput');
    const submitBtn = document.getElementById('modalSubmitBtn');
    const errorEl = document.getElementById('modalError');
    const messageText = document.getElementById('modalMessageText');
    const messageSubtext = document.getElementById('modalMessageSubtext');
    
    messageDiv.classList.add('hidden');
    formDiv.classList.add('hidden');
    deleteButtons.classList.add('hidden');
    errorEl.classList.add('hidden');
    title.textContent = config.title;
    
    if (config.type === 'delete') {
        messageDiv.classList.remove('hidden');
        deleteButtons.classList.remove('hidden');
        messageText.textContent = config.message;
        messageSubtext.textContent = config.subtext || '';
        
        document.getElementById('modalDeleteConfirm').onclick = () => {
            if (config.itemType === 'folder') deleteFolderConfirmed(config.itemId);
            else deleteFileConfirmed(config.itemId);
        };
        
    } else if (config.type === 'rename' || config.type === 'create') {
        formDiv.classList.remove('hidden');
        label.textContent = config.label;
        input.placeholder = config.placeholder;
        input.value = config.defaultValue || '';
        submitBtn.textContent = config.submitText;
        
        document.getElementById('modalItemId').value = config.itemId || '';
        document.getElementById('modalItemType').value = config.itemType;
        document.getElementById('modalAction').value = config.type;
        
        const modalForm = document.getElementById('modalForm');
        if (config.type === 'create') {
            modalForm.action = "{% url 'create_folder' %}";
        } else {
            modalForm.action = config.itemType === 'folder' 
                ? "{% url 'rename_folder' %}" 
                : "{% url 'rename_file' %}";
        }
        
        setTimeout(() => input.focus(), 100);
    }
    
    modal.classList.remove('hidden');
}

function closeUnifiedModal() {
    document.getElementById('unifiedModal').classList.add('hidden');
    clearSelection();
}

function deleteFolderConfirmed(folderId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "delete_folder" %}';
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrf) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrf.value;
        form.appendChild(csrfInput);
    }
    const idInput = document.createElement('input');
    idInput.type = 'hidden';
    idInput.name = 'folder_id';
    idInput.value = folderId;
    form.appendChild(idInput);
    document.body.appendChild(form);
    form.submit();
}

function deleteFileConfirmed(fileId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `{% url 'delete_file' 0 %}`.replace('0', fileId);
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken.value;
        form.appendChild(csrfInput);
    }
    
    document.body.appendChild(form);
    form.submit();
}

function validateModalInput(itemType, value) {
    if (!value.trim()) {
        return itemType === 'folder' 
            ? 'Имя папки не может быть пустым'
            : 'Имя файла не может быть пустым';
    }
    const forbidden = ['/', '\\', ':', '*', '?', '"', '<', '>', '|'];
    for (const char of forbidden) {
        if (value.includes(char)) {
            return `Имя не может содержать символ "${char}"`;
        }
    }
    if (value.endsWith('.') || value.endsWith(' ')) {
        return 'Имя не может заканчиваться точкой или пробелом';
    }
    return null;
}

document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') lucide.createIcons();
    
    const modalForm = document.getElementById('modalForm');
    if (modalForm) {
        modalForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const action = document.getElementById('modalAction').value;
            const itemType = document.getElementById('modalItemType').value;
            const newName = document.getElementById('modalInput').value;
            const errorEl = document.getElementById('modalError');

            const error = validateModalInput(itemType, newName);
            if (error) {
                errorEl.textContent = error;
                errorEl.classList.remove('hidden');
                return;
            }
            errorEl.classList.add('hidden');
            
            if (action === 'create') {
              const pathInput = document.getElementById('modalCurrentPath');
              if (pathInput) {
                  console.log('Creating folder with path:', pathInput.value);
              }
              this.submit();
              return;
            }

            if (action === 'rename') {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = itemType === 'folder' 
                    ? '{% url "rename_folder" %}' 
                    : '{% url "rename_file" %}';
                
                const csrf = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrf) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = csrf.value;
                    form.appendChild(csrfInput);
                }
                
                const idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.name = itemType === 'folder' ? 'folder_id' : 'file_id';
                idInput.value = document.getElementById('modalItemId').value;
                form.appendChild(idInput);
                
                const nameInput = document.createElement('input');
                nameInput.type = 'hidden';
                nameInput.name = 'new_name';
                nameInput.value = newName;
                form.appendChild(nameInput);
                
                const pathInput = document.getElementById('modalCurrentPath');
                if (pathInput && pathInput.value) {
                    const pathCopy = document.createElement('input');
                    pathCopy.type = 'hidden';
                    pathCopy.name = 'path';
                    pathCopy.value = pathInput.value;
                    form.appendChild(pathCopy);
                }
                
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
    
    document.querySelectorAll('.folder-item').forEach(el => {
        el.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showFolderContextMenu(e.clientX, e.clientY, el);
        });
    });
    
    document.querySelectorAll('.file-item').forEach(el => {
        el.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showFileContextMenu(e.clientX, e.clientY, el);
        });
    });
    
    const emptyArea = document.getElementById('emptyArea');
    if (emptyArea) {
        emptyArea.addEventListener('contextmenu', showEmptyAreaContextMenu);
    }
    
    const fileManager = document.getElementById('fileManager');
    if (fileManager) {
        fileManager.addEventListener('contextmenu', (e) => {
            const target = e.target;
            const isItem = target.closest('.folder-item') || target.closest('.file-item');
            const isEmptyArea = target.id === 'emptyArea' || target.closest('#emptyArea');
            
            if (!isItem && !isEmptyArea) {
                e.preventDefault();
                showEmptyAreaContextMenu(e);
            }
        });
    }
    
    document.addEventListener('click', (e) => {
        const target = e.target;
        const isItem = target.closest('.folder-item') || target.closest('.file-item');
        const isMenu = target.closest('#contextMenu') || 
                      target.closest('#folderContextMenu') || 
                      target.closest('#fileContextMenu');
        const isModal = target.closest('#unifiedModal');
        
        if (!isItem && !isMenu && !isModal) {
            clearSelection();
        }
    });
});

document.getElementById('unifiedModal')?.addEventListener('click', (e) => {
    if (e.target === document.getElementById('unifiedModal')) {
        closeUnifiedModal();
    }
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeUnifiedModal();
        ContextMenuController.hide();
        clearSelection();
    }
});

function showCreateFolderModal() {
    showUnifiedModal({
        title: 'Создать папку',
        type: 'create',
        itemType: 'folder',
        label: 'Имя папки',
        placeholder: 'Введите название папки',
        submitText: 'Создать'
    });
}
</script>
{% endblock %}